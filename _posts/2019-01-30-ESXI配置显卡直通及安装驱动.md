---
title: ESXI配置显卡直通及安装驱动
layout: post
categories: LINUX
tags: 'ESXI,LINUX,NVIDIA'
---
# ESXI配置显卡直通及安装驱动

## 概述
某台联想长风的配有8张1080TI显卡的GPU服务器，由于需求调整，需要从单独跑LINUX（RHEL7.2）调整为同时跑LINUX和WINDOWS，且使用GPU资源。根据情况，拟使用ESXI虚拟化物理服务器，配置显卡直通来让虚拟机使用显卡资源。经过两天的查找资料和实践，完成了此需求，并将过程中遇到的问题记录成此文档，以备将来遇到同样的情况时使用。

## 目录
- [概述](#概述)
- [基础环境](#基础环境)
- [ESXI安装与配置](#ESXI安装与配置)
- [安装显卡驱动](#安装显卡驱动)
- [后记](#后记)

## 基础环境
- 联想长风服务器（配8张1080TI显卡）
- EXSI6.7
- win10
- CentOS7.5
- 相关驱动

## ESXI安装与配置

### ESXI安装
安装过程并非技术生难点，不作细述，按照正常流程安装即可，需要注意的是，在第一次安装的时候照搬文档[
使用VMware ESXi 6.5配置显卡直通](https://blog.csdn.net/zhanxix/article/details/71516316)禁用了板载显卡，导致服务器卡死在`system initializing    91`处，无法进入操作系统和BIOS，最后联系现象售后通过开箱CMOS放电才解决，结果BIOS默认配置即可安装ESXI虚拟化。__所有涉及BIOS的问题，除非有相关修改经验，能咨询官方的一定先咨询官方，以免造成不必要的麻烦__。

### ESXI配置
在安装好ESXI，并配置好IP后，通过Web Client访问该主机，配置显卡直通。__需注意的是，显卡直通配置后需要重启EXSI主机才能生效__。配置过程如下：
1. 登陆ESXI
2. 在`主机->管理->硬件->PCI设备`中，勾选需要直通的8张显卡，点击`切换为直通`
3. 重启ESXI主机
4. 新建虚拟机或以后虚拟机的硬件编辑中，点击`添加其他设备`，在下拉框中选择`PCI设备`
5. 在新加的PCI设备的下拉框中选择相应的显卡，需注意的是__a. PCI直通显卡为独占设备，多台虚拟机无法共用同一张卡，添加可以成功但会导致虚拟机无法启动；b. PCI直通显卡需点击`预留内存`，否则也会导致虚拟机无法启动__
6. 在ESXI主机上，编辑虚拟机的VMX文件，添加`hypervisor.cpuid.v0 = "FALSE"`一行到文件当中（__此步非常关键，否则虚拟机即使装上显卡驱动，也无法正常运行该驱动，windows中，设备管理器报设备异常，停止运行，linux中，使用`nvidia-smi`命令，报__`cannot detemeter the handle of the device:unknown error`）

## 安装显卡驱动

### windows安装显卡驱动
较为简单，在nvidia官网下载相应驱动，直接执行exe文件即可。

### linux安装显卡驱动
准确的说应为CentOS7.5安装nvidia geforce 1080ti驱动。此过程比较麻烦，需禁用与之冲突的nouveau，需关闭图形化界面进行安装，需安装gcc、gcc-c++、kernel-devel（kernel-devel的小版本也要同内核版本一直，否则会导致驱动安装失败），在执行驱动安装程序找不到kernel路径时还得手动指定路径。具体安装步骤如下所示：

#### 禁用nouveau
- 编辑`/etc/modprobe.d/blacklist.conf`，在文件后面加入`blacklist nouveau`
- root用户下运行如下两条命令：
```shell
mv /boot/initramfs-$(uname -r).img /boot/initramfs-$(uname -r).img.bak
dracut -v /boot/initramfs-$(uname -r).img $(uname -r) 
```
#### 关闭图形化界面
```shell
init 3
systemctl set-default multi-user.target
```

#### 安装必要utils
```shell
yum install -y gcc gcc-c++ kernel-devel-$(uname -r)
```
由于kernel-devel的版本经常比内核版本新，如果找不到`kernel-devel-$(uname -r)`的话，可以在安装介质的Packages路径下通过`rpm -ivh kernel-devel-$(uname -r)`来进行安装

#### 安装nvidia驱动
在完成以上步骤后，即可运行从官网下载的安装程序
```shell
chmod +x [driver-downloaded-from-official-website]
./[driver-downloaded-from-official-website]
# 如果报找不到kernel路径，执行一下命令
./[driver-downloaded-from-official-website] --kernel-source-path=/usr/src/kernel/$(uname -r)/
```
至此，CentOS7.5安装nvidia geforce 1080ti驱动完成。

## 后记
nouveau是开源的第三方N卡驱动，根据需求使用它还是使用官方驱动。联想售后说，他们测试的ESXI6.5，通过虚拟化最多只能带得动4张显卡，目前在ESXI6.7上，8张显卡都直通到了虚拟机，后面应用运行是否会有问题还待观察。